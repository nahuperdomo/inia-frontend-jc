# ๐ Flujo de Datos - Exportaciรณn Excel

## Diagrama del Flujo Completo

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                        USUARIO FRONTEND                         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                         โ
                         โ 1. Click en botรณn "Exportar"
                         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ              COMPONENTE REACT (Frontend)                        โ
โ  โข BotonExportarExcel.tsx                                       โ
โ  โข DialogExportarConFiltros.tsx                                 โ
โ                                                                  โ
โ  Estado: isExporting = true                                     โ
โ  Acciรณn: Llama a exportacion-service                            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                         โ
                         โ 2. Ejecuta funciรณn async
                         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ            SERVICIO DE EXPORTACIรN (Frontend)                   โ
โ  exportacion-service.ts                                         โ
โ                                                                  โ
โ  โข Obtiene token JWT de localStorage                            โ
โ  โข Construye URL con parรกmetros/body                            โ
โ  โข Configura headers (Authorization, Content-Type)              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                         โ
                         โ 3. HTTP Request
                         โ    GET /api/exportaciones/excel
                         โ    o POST /api/exportaciones/excel/avanzado
                         โ    Headers: { Authorization: Bearer <token> }
                         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                  RED / INTERNET                                 โ
โ  localhost:3000 (Frontend) โ localhost:8080 (Backend)           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                         โ
                         โ 4. Request llega al backend
                         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ          SPRING BOOT SECURITY (Backend)                         โ
โ  JWT Authentication Filter                                      โ
โ                                                                  โ
โ  โข Valida token JWT                                             โ
โ  โข Verifica roles (ADMIN, ANALISTA, OBSERVADOR)                 โ
โ  โข Extrae informaciรณn del usuario                               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                         โ
                         โ 5. Autenticaciรณn exitosa
                         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ            CONTROLADOR REST (Backend)                           โ
โ  ExportacionController.java                                     โ
โ  @RestController @RequestMapping("/api/exportaciones")          โ
โ                                                                  โ
โ  Endpoints disponibles:                                         โ
โ  โข @GetMapping("/excel")                                        โ
โ  โข @GetMapping("/excel/lote/{loteId}")                          โ
โ  โข @PostMapping("/excel/personalizado")                         โ
โ  โข @PostMapping("/excel/avanzado")                              โ
โ                                                                  โ
โ  โข Recibe parรกmetros/DTO                                        โ
โ  โข Valida entrada                                               โ
โ  โข Llama al servicio                                            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                         โ
                         โ 6. Llama al servicio
                         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ              SERVICIO DE EXPORTACIรN (Backend)                  โ
โ  ExportacionExcelService.java                                   โ
โ  @Service                                                       โ
โ                                                                  โ
โ  Mรฉtodos principales:                                           โ
โ  โข generarReporteExcel(List<Long> loteIds)                      โ
โ  โข generarReporteExcelAvanzado(ExportacionRequestDTO)           โ
โ  โข obtenerDatosParaExportacion(loteIds)                         โ
โ  โข obtenerDatosConFiltros(solicitud)                            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                         โ
                         โ 7. Consulta base de datos
                         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    REPOSITORIOS JPA                             โ
โ  โข LoteRepository                                               โ
โ  โข PurezaRepository                                             โ
โ  โข GerminacionRepository                                        โ
โ  โข PmsRepository                                                โ
โ  โข TetrazolioRepository                                         โ
โ  โข DosnRepository                                               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                         โ
                         โ 8. Query SQL a la DB
                         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    BASE DE DATOS                                โ
โ  PostgreSQL / MySQL / H2                                        โ
โ                                                                  โ
โ  Tablas consultadas:                                            โ
โ  โข lote                                                         โ
โ  โข pureza                                                       โ
โ  โข germinacion                                                  โ
โ  โข pms                                                          โ
โ  โข tetrazolio                                                   โ
โ  โข dosn                                                         โ
โ  โข listado (malezas y otros cultivos)                           โ
โ  โข cultivar                                                     โ
โ  โข especie                                                      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                         โ
                         โ 9. Retorna entidades JPA
                         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ            MAPEO DE DATOS (Backend Service)                     โ
โ  ExportacionExcelService.java                                   โ
โ                                                                  โ
โ  Mรฉtodos de mapeo:                                              โ
โ  โข mapearDatosBasicosLote()                                     โ
โ  โข mapearDatosPureza()                                          โ
โ  โข mapearDatosGerminacion()                                     โ
โ  โข mapearDatosPms()                                             โ
โ  โข mapearDatosTetrazolio()                                      โ
โ  โข mapearDatosDosn()                                            โ
โ                                                                  โ
โ  Resultado: List<DatosExportacionExcelDTO>                      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                         โ
                         โ 10. Genera Excel con Apache POI
                         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ            GENERACIรN EXCEL (Apache POI)                        โ
โ  ExportacionExcelService.java                                   โ
โ                                                                  โ
โ  Proceso:                                                       โ
โ  1. new XSSFWorkbook()                                          โ
โ  2. createSheet("Anรกlisis de Semillas")                         โ
โ  3. crearEstilos (headers, data, colores)                       โ
โ  4. crearEncabezados (fila 0 y 1)                               โ
โ  5. Para cada DTO:                                              โ
โ     โข crearFilaDatos()                                          โ
โ     โข Llenar celdas con valores                                 โ
โ     โข Aplicar estilos                                           โ
โ  6. ajustarAnchoColumnas()                                      โ
โ  7. workbook.write(ByteArrayOutputStream)                       โ
โ                                                                  โ
โ  Resultado: byte[] (archivo Excel)                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                         โ
                         โ 11. Retorna byte[]
                         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ            RESPUESTA HTTP (Backend Controller)                  โ
โ  ExportacionController.java                                     โ
โ                                                                  โ
โ  โข Genera nombre de archivo con timestamp                       โ
โ  โข Configura headers HTTP:                                      โ
โ    - Content-Type: application/octet-stream                     โ
โ    - Content-Disposition: attachment; filename="..."            โ
โ    - Content-Length: <tamaรฑo del archivo>                       โ
โ  โข Retorna ResponseEntity<byte[]>                               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                         โ
                         โ 12. HTTP Response
                         โ     Status: 200 OK
                         โ     Body: byte[] (archivo Excel)
                         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                  RED / INTERNET                                 โ
โ  localhost:8080 (Backend) โ localhost:3000 (Frontend)           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                         โ
                         โ 13. Response llega al frontend
                         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ            SERVICIO DE EXPORTACIรN (Frontend)                   โ
โ  exportacion-service.ts                                         โ
โ                                                                  โ
โ  โข Verifica response.ok                                         โ
โ  โข Convierte a Blob: await response.blob()                      โ
โ  โข Retorna Blob al componente                                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                         โ
                         โ 14. Blob recibido
                         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ              COMPONENTE REACT (Frontend)                        โ
โ  BotonExportarExcel.tsx / DialogExportarConFiltros.tsx          โ
โ                                                                  โ
โ  โข Genera nombre de archivo                                     โ
โ  โข Llama a descargarArchivo(blob, nombre)                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                         โ
                         โ 15. Descarga archivo
                         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ            DESCARGA DE ARCHIVO (Frontend)                       โ
โ  exportacion-service.ts โ descargarArchivo()                    โ
โ                                                                  โ
โ  Proceso:                                                       โ
โ  1. URL.createObjectURL(blob)                                   โ
โ  2. document.createElement('a')                                 โ
โ  3. link.href = url                                             โ
โ  4. link.download = nombreArchivo                               โ
โ  5. link.click()                                                โ
โ  6. URL.revokeObjectURL(url)                                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                         โ
                         โ 16. Archivo descargado
                         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ              NOTIFICACIรN AL USUARIO                            โ
โ  โข toast.success("Excel exportado exitosamente")                โ
โ  โข Estado: isExporting = false                                  โ
โ  โข Botรณn vuelve a estado normal                                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                         โ
                         โ 17. Usuario ve archivo descargado
                         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    SISTEMA DE ARCHIVOS                          โ
โ  Carpeta de Descargas del navegador                             โ
โ  Archivo: analisis_semillas_20241015_143052.xlsx                โ
โ  Tamaรฑo: ~50-500 KB (depende de cantidad de lotes)              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ Detalle de las Estructuras de Datos

### Frontend โ Backend

#### Request GET simple:
```
GET /api/exportaciones/excel
Headers: {
  Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
}
```

#### Request GET con parรกmetros:
```
GET /api/exportaciones/excel?loteIds=1,2,3
Headers: {
  Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
}
```

#### Request POST con filtros:
```
POST /api/exportaciones/excel/avanzado
Headers: {
  Content-Type: application/json,
  Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
}
Body: {
  "loteIds": [1, 2, 3],
  "fechaDesde": "2024-01-01",
  "fechaHasta": "2024-12-31",
  "especieIds": [1, 2],
  "cultivarIds": [5, 10],
  "incluirInactivos": false,
  "tiposAnalisis": ["PUREZA", "GERMINACION", "PMS"],
  "incluirEncabezados": true,
  "incluirColoresEstilo": true,
  "formatoFecha": "dd/MM/yyyy"
}
```

### Backend โ Frontend

#### Response exitosa:
```
Status: 200 OK
Headers: {
  Content-Type: application/octet-stream,
  Content-Disposition: attachment; filename="analisis_semillas_20241015_143052.xlsx",
  Content-Length: 156742
}
Body: <binary data del archivo Excel>
```

#### Response error 401:
```
Status: 401 Unauthorized
Body: "Token invรกlido o expirado"
```

#### Response error 500:
```
Status: 500 Internal Server Error
Body: "Error al generar archivo Excel: ..."
```

---

## ๐ Transformaciรณn de Datos

### 1. Entidad JPA (Base de Datos)
```java
Lote {
  loteID: 1,
  ficha: "LOTE-2024-001",
  kilosLimpios: 500.5,
  cultivar: Cultivar {
    nombre: "Don Mario",
    especie: Especie {
      nombreComun: "Soja"
    }
  }
}
```

### 2. DTO Intermedio (Backend)
```java
DatosExportacionExcelDTO {
  especie: "Soja",
  variedad: "Don Mario",
  lote: "LOTE-2024-001",
  kilos: "500.5",
  purezaSemillaPura: 98.5,
  germinacionTotal: 95.0,
  pms: 180.5,
  // ... mรกs campos
}
```

### 3. Celda Excel (Archivo generado)
```
| A      | B          | C              | ... | J     |
|--------|------------|----------------|-----|-------|
| Soja   | Don Mario  | LOTE-2024-001  | ... | 98.5  |
```

### 4. Archivo Descargado (Usuario)
```
๐ Descargas/
  โโโ analisis_semillas_20241015_143052.xlsx
      โข Tamaรฑo: 156 KB
      โข Formato: Excel 2007+ (.xlsx)
      โข Hojas: 1 ("Anรกlisis de Semillas")
      โข Filas: 2 (encabezados) + N (datos)
      โข Columnas: 52 (A hasta AZ)
```

---

## โฑ๏ธ Tiempos Estimados

| Etapa | Tiempo |
|-------|--------|
| Click del usuario โ Request HTTP | < 10 ms |
| Request โ Autenticaciรณn JWT | 5-20 ms |
| Consultas a base de datos | 50-500 ms |
| Mapeo de datos | 10-100 ms |
| Generaciรณn Excel (Apache POI) | 100-1000 ms |
| Transferencia HTTP | 10-200 ms |
| Descarga en navegador | < 50 ms |
| **TOTAL** | **~200-2000 ms** |

*Los tiempos varรญan segรบn la cantidad de lotes y anรกlisis.*

---

## ๐ Seguridad

### Puntos de validaciรณn:

1. **Frontend:** Token en localStorage
2. **Backend Security Filter:** Validaciรณn JWT
3. **Backend Controller:** Verificaciรณn de roles con `@PreAuthorize`
4. **Backend Service:** Filtrado de datos segรบn permisos
5. **Base de datos:** Solo datos del usuario autenticado (si aplica)

### Roles permitidos:
- โ ROLE_ADMIN
- โ ROLE_ANALISTA
- โ ROLE_OBSERVADOR
- โ ROLE_USER (sin acceso)

---

## ๐จ Formato y Estilos

### Colores aplicados:
- **Encabezados:** Gris claro (#D9D9D9)
- **Datos INASE:** Amarillo (#FFFF00)
- **Bordes:** Todos los lados, lรญnea fina
- **Fuente:** Arial 11pt (encabezados bold)

### Alineaciรณn:
- **Encabezados:** Centrado
- **Datos texto:** Izquierda
- **Datos numรฉricos:** Derecha (automรกtico)

### Anchos de columna:
- **Columnas A-H:** Auto-ajustado (mรญnimo 3000 unidades)
- **Columnas I-AZ:** Ancho fijo 2500 unidades

---

## ๐ Optimizaciones Futuras

1. **Cachรฉ:** Cachear datos de especies/cultivares
2. **Paginaciรณn:** Exportar en lotes para archivos grandes
3. **Async:** Generar Excel en background con cola de tareas
4. **Compresiรณn:** Comprimir antes de enviar (gzip)
5. **Streaming:** Streaming de datos para archivos muy grandes
6. **Notificaciones:** Email cuando el archivo estรฉ listo

---

**รltima actualizaciรณn:** 2024-10-15
